# ================================================================================================
# Archery 生产级Supervisor配置
# 
# 包含功能：
# - Django Q异步任务队列（核心服务，自动启动）
# - 定时任务管理（可选，默认关闭）
# - 系统监控脚本（可选，默认关闭）
# - 内存监控事件监听器（可选，默认关闭）
# 
# 注意事项：
# 1. 可选服务默认设置为 autostart=false，根据需要启用
# 2. 监控功能需要psutil依赖包，如缺失会导致启动失败
# 3. 定时任务需要应用支持crontab命令
# ================================================================================================

[unix_http_server]
file=/tmp/supervisor.sock
chmod=0700

[supervisord]
logfile=/opt/archery/logs/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=/tmp/supervisord.pid
nodaemon=false
minfds=1024
minprocs=200
user=root

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory=supervisor.rpcinterface:make_main_rpcinterface

# ================================================================================================
# Django Q 异步任务队列
# ================================================================================================
[program:qcluster]
command=/opt/venv4archery/bin/python manage.py qcluster
directory=/opt/archery
user=root
autostart=true
autorestart=true
startretries=3
stopasgroup=true
killasgroup=true
redirect_stderr=true
stdout_logfile=/opt/archery/logs/qcluster.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10

# ================================================================================================
# 可选：定时任务 (如果需要)
# ================================================================================================
[program:cron_tasks]
command=/opt/venv4archery/bin/python manage.py crontab add
directory=/opt/archery
user=root
autostart=false
autorestart=false
redirect_stderr=true
stdout_logfile=/opt/archery/logs/cron.log

# ================================================================================================
# 可选：监控脚本 (如果需要)
# ================================================================================================
[program:monitor]
command=/opt/venv4archery/bin/python manage.py monitor
directory=/opt/archery
user=root
autostart=false
autorestart=true
redirect_stderr=true
stdout_logfile=/opt/archery/logs/monitor.log 